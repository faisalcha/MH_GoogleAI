resource "aws_sns_topic" "alerts" { name = "mazdoorhub-alerts" }
resource "aws_sns_topic_subscription" "email" { topic_arn = aws_sns_topic.alerts.arn, protocol="email", endpoint=var.alarm_email }
resource "aws_cloudwatch_metric_alarm" "api_5xx" { alarm_name="mh-api-5xx"; comparison_operator="GreaterThanThreshold"; evaluation_periods=1; threshold=10; metric_name="5xx"; namespace="AWS/ApiGateway"; statistic="Sum"; period=60; dimensions={ ApiId=var.api_gateway_id }; alarm_actions=[aws_sns_topic.alerts.arn] }
resource "aws_cloudwatch_metric_alarm" "api_latency_p95" { alarm_name="mh-api-latency-p95"; comparison_operator="GreaterThanThreshold"; evaluation_periods=3; threshold=800; metric_name="Latency"; namespace="AWS/ApiGateway"; extended_statistic="p95"; period=60; dimensions={ ApiId=var.api_gateway_id }; alarm_actions=[aws_sns_topic.alerts.arn] }
resource "aws_cloudwatch_metric_alarm" "lambda_errors" { for_each=toset(var.lambda_function_names); alarm_name="mh-lambda-${each.key}-errors"; comparison_operator="GreaterThanThreshold"; evaluation_periods=1; threshold=5; metric_name="Errors"; namespace="AWS/Lambda"; statistic="Sum"; period=60; dimensions={ FunctionName=each.key }; alarm_actions=[aws_sns_topic.alerts.arn] }
resource "aws_cloudwatch_metric_alarm" "rds_cpu" { alarm_name="mh-rds-cpu-high"; comparison_operator="GreaterThanThreshold"; evaluation_periods=2; threshold=80; metric_name="CPUUtilization"; namespace="AWS/RDS"; statistic="Average"; period=60; dimensions={ DBInstanceIdentifier=var.rds_instance_id }; alarm_actions=[aws_sns_topic.alerts.arn] }
resource "aws_cloudwatch_dashboard" "main" { dashboard_name=var.dashboard_name; dashboard_body = file("${path.module}/dashboard.json") }
