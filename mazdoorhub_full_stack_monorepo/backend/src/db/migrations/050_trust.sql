CREATE TABLE IF NOT EXISTS references_requests ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), worker_user_id uuid NOT NULL, ref_name varchar(120) NOT NULL, ref_phone varchar(32) NOT NULL, status varchar(16) NOT NULL DEFAULT 'PENDING', token varchar(64) UNIQUE NOT NULL, response_rating int, response_text text, created_at timestamptz NOT NULL DEFAULT now(), responded_at timestamptz, verified_at timestamptz ); CREATE TABLE IF NOT EXISTS verification_badges ( user_id uuid NOT NULL, badge varchar(32) NOT NULL, active boolean NOT NULL DEFAULT true, created_at timestamptz NOT NULL DEFAULT now(), PRIMARY KEY (user_id, badge)); CREATE TABLE IF NOT EXISTS worker_stats ( user_id uuid PRIMARY KEY, jobs_completed int NOT NULL DEFAULT 0, total_rating int NOT NULL DEFAULT 0, rating_count int NOT NULL DEFAULT 0, avg_rating numeric(4,2) GENERATED ALWAYS AS (CASE WHEN rating_count=0 THEN 0 ELSE round((total_rating::numeric / rating_count)::numeric,2) END) STORED, rated_pro boolean NOT NULL DEFAULT false, updated_at timestamptz NOT NULL DEFAULT now() ); CREATE OR REPLACE VIEW trust_reference_queue AS SELECT id, worker_user_id, ref_name, ref_phone, status, created_at, responded_at FROM references_requests WHERE status IN ('PENDING','SENT','RESPONDED') ORDER BY created_at ASC;